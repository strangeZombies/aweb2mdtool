import { twind, cssom, observe } from '@twind/core';
import 'construct-style-sheets-polyfill'; // 用于支持 shadowroot.adoptedStyleSheets
import config from '../twind.config';

import { render } from 'preact';
import { App } from '@/core/app';
import logger from '@/utils/logger';
import packageJson from '../package.json';

// 创建 twind 实例，使用 CSSStyleSheet
const sheet = cssom(new CSSStyleSheet());
const tw = twind(config, sheet);

// Function to create Shadow DOM and render the application
function createShadowDom() {
  if (window.top === window) {
    try {
      // 创建一个 div 元素作为根，并设置 id
      const rootDiv = document.createElement('div');
      const globalStyles = `#${packageJson.name}Div { all: unset !重要; width: auto !important; height: auto !important; }`;
      const globalStyleElement = document.createElement('style');
      globalStyleElement.textContent = globalStyles;
      document.head.appendChild(globalStyleElement);

      rootDiv.id = `${packageJson.name}Div`;
      document.documentElement.appendChild(rootDiv);
      const shadowDOM = rootDiv.attachShadow({ mode: 'open' });

      // Ensure that the style sheet is correctly adopted by Shadow DOM
      shadowDOM.adoptedStyleSheets = [sheet.target];

      // Observe and apply styles using twind
      observe(tw, shadowDOM);

      // Render Preact application into Shadow DOM
      render(<App className={tw('app')} />, shadowDOM);
    } catch (error) {
      logger.error('Error creating Shadow DOM:', error);
    }
  }
}

// Mount the application
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', createShadowDom);
} else {
  createShadowDom();
}
